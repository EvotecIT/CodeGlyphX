@page "/playground"
@using Microsoft.AspNetCore.Components.WebAssembly.Services
@inject LazyAssemblyLoader AssemblyLoader

<PageTitle>Playground - CodeGlyphX</PageTitle>

<div class="playground">
    @if (_loadError != null)
    {
        <div class="card">
            <h2>Playground unavailable</h2>
            <p>@_loadError</p>
        </div>
    }
    else if (_playgroundType == null)
    {
        <div class="card">
            <h2>Loading playground...</h2>
            <p>Downloading the CodeGlyphX engine. This is only required the first time you open the playground.</p>
        </div>
    }
    else
    {
        <DynamicComponent Type="_playgroundType" @key="_componentKey" />
    }
</div>

@code {
    private Type? _playgroundType;
    private string? _loadError;
    private int _componentKey;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Exception? lastError = null;

            foreach (var candidates in new[]
                     {
                         new[] { "CodeGlyphX.Playground.wasm", "CodeGlyphX.wasm" },
                         new[] { "CodeGlyphX.Playground.dll", "CodeGlyphX.dll" }
                     })
            {
                try
                {
                    var assemblies = await AssemblyLoader.LoadAssembliesAsync(candidates);
                    _playgroundType = assemblies
                        .Select(assembly => assembly.GetType("CodeGlyphX.Playground.Playground"))
                        .FirstOrDefault(type => type != null);
                    if (_playgroundType != null)
                        break;
                }
                catch (Exception ex)
                {
                    lastError = ex;
                }
            }

            if (_playgroundType is null)
                _loadError = lastError?.Message ?? "Playground component failed to load.";
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_playgroundType != null && _componentKey == 0)
        {
            // Wait a tick to ensure assemblies are fully initialized
            await Task.Yield();
            _componentKey++; // Force fresh component instance
            StateHasChanged();
        }
    }
}
