@page "/playground"
@using Microsoft.AspNetCore.Components.WebAssembly.Services
@inject LazyAssemblyLoader AssemblyLoader

<PageTitle>Playground - CodeGlyphX</PageTitle>

<div class="playground">
    @if (_loadError != null)
    {
        <div class="card">
            <h2>Playground unavailable</h2>
            <p>@_loadError</p>
        </div>
    }
    else if (!_isReady)
    {
        <div class="card">
            <h2>Loading playground...</h2>
            <p>Downloading the CodeGlyphX engine. This is only required the first time you open the playground.</p>
        </div>
    }
    else
    {
        <CodeGlyphX.Playground.Playground @key="_componentKey" />
    }
</div>

@code {
    private bool _assembliesLoaded;
    private bool _isReady;
    private string? _loadError;
    private int _componentKey;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Only need to lazy load CodeGlyphX.wasm - Playground component is bundled with main app
            foreach (var candidate in new[] { "CodeGlyphX.wasm", "CodeGlyphX.dll" })
            {
                try
                {
                    await AssemblyLoader.LoadAssembliesAsync(new[] { candidate });
                    _assembliesLoaded = true;
                    break;
                }
                catch
                {
                    // Try next candidate
                }
            }

            if (!_assembliesLoaded)
                _loadError = "CodeGlyphX engine failed to load.";
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_assembliesLoaded && !_isReady)
        {
            // Wait a tick to ensure assemblies are fully initialized
            await Task.Yield();
            _isReady = true;
            _componentKey++; // Force fresh component instance
            StateHasChanged();
        }
    }
}
