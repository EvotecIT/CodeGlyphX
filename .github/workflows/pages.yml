name: Deploy Website

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore CodeGlyphX.Website/CodeGlyphX.Website.csproj

      - name: Install PSParseHTML module
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSParseHTML -Force -Scope CurrentUser

      - name: Build website (static + playground)
        run: pwsh Build/Publish-WebsitePages.ps1 -Configuration Release -Framework net10.0 -OutputPath site -MinifyAssets

      - name: Verify website output
        run: |
          test -f site/.nojekyll
          test -f site/index.html
          test -f site/docs/index.html
          test -f site/playground/index.html

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Test website
        run: |
          # Start local server in background
          npx serve site -l 5051 &
          SERVER_PID=$!
          sleep 3

          # Run all website tests
          node -e "
          const { chromium } = require('playwright');

          async function testMobileLayout(page, pages, viewports, maxOverflow) {
              let failures = [];
              for (const vw of viewports) {
                  await page.setViewportSize({ width: vw, height: 667 });
                  for (const path of pages) {
                      const url = 'http://localhost:5051' + path;
                      console.log('Testing layout:', url, 'at', vw + 'px');
                      try {
                          await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });
                          const overflow = await page.evaluate(({vw, max}) => {
                              const docWidth = document.documentElement.scrollWidth;
                              return docWidth - vw > max ? docWidth - vw : 0;
                          }, {vw, max: maxOverflow});
                          if (overflow > 0) {
                              failures.push({ test: 'mobile-layout', page: path, viewport: vw, overflow });
                          }
                      } catch (err) {
                          failures.push({ test: 'mobile-layout', page: path, viewport: vw, error: err.message });
                      }
                  }
              }
              return failures;
          }

          async function testBlazorApp(page, path, appName) {
              const url = 'http://localhost:5051' + path;
              console.log('Testing Blazor app:', appName, 'at', url);
              let failures = [];

              // Collect console errors
              const errors = [];
              page.on('console', msg => {
                  if (msg.type() === 'error') errors.push(msg.text());
              });
              page.on('pageerror', err => errors.push(err.message));

              try {
                  await page.goto(url, { timeout: 60000 });

                  // Wait for Blazor to initialize (loading indicator to disappear)
                  await page.waitForFunction(() => {
                      const loading = document.querySelector('.loading-progress, .loading, [class*=\"loading\"]');
                      const blazorError = document.body.innerText.includes('error') &&
                                          document.body.innerText.includes('reload');
                      return !loading && !blazorError;
                  }, { timeout: 45000 });

                  // Check for critical Blazor errors
                  const criticalErrors = errors.filter(e =>
                      e.includes('blazor') ||
                      e.includes('WebAssembly') ||
                      e.includes('Failed to fetch') ||
                      e.includes('404')
                  );

                  if (criticalErrors.length > 0) {
                      failures.push({
                          test: 'blazor-init',
                          app: appName,
                          errors: criticalErrors.slice(0, 3)
                      });
                  }

                  // Verify app rendered (has interactive content)
                  const hasContent = await page.evaluate(() => {
                      const main = document.querySelector('main, .main, [role=\"main\"], .app');
                      return main && main.children.length > 0;
                  });

                  if (!hasContent) {
                      failures.push({
                          test: 'blazor-render',
                          app: appName,
                          error: 'App did not render content'
                      });
                  }

                  console.log('  ✓', appName, 'loaded successfully');
              } catch (err) {
                  failures.push({
                      test: 'blazor-load',
                      app: appName,
                      error: err.message
                  });
              }

              return failures;
          }

          (async () => {
              const browser = await chromium.launch();
              const context = await browser.newContext();
              const page = await context.newPage();
              let allFailures = [];

              // Test 1: Mobile layout for static pages
              console.log('\\n=== Testing Mobile Layout ===');
              const layoutFailures = await testMobileLayout(
                  page,
                  ['/', '/showcase/', '/faq/'],
                  [375, 390, 414],
                  5
              );
              allFailures.push(...layoutFailures);

              // Test 2: Blazor apps load correctly
              console.log('\\n=== Testing Blazor Apps ===');
              await page.setViewportSize({ width: 1280, height: 800 });

              const docsFailures = await testBlazorApp(page, '/docs/', 'Documentation');
              allFailures.push(...docsFailures);

              const playgroundFailures = await testBlazorApp(page, '/playground/', 'Playground');
              allFailures.push(...playgroundFailures);

              // Test 3: Mobile layout for Blazor apps
              console.log('\\n=== Testing Blazor Apps Mobile Layout ===');
              const blazorLayoutFailures = await testMobileLayout(
                  page,
                  ['/docs/', '/playground/'],
                  [375, 414],
                  10  // Slightly more tolerance for complex Blazor apps
              );
              allFailures.push(...blazorLayoutFailures);

              await browser.close();

              if (allFailures.length > 0) {
                  console.error('\\n=== FAILURES ===');
                  console.error(JSON.stringify(allFailures, null, 2));
                  process.exit(1);
              }
              console.log('\\n✓ All website tests passed!');
          })();
          "

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
