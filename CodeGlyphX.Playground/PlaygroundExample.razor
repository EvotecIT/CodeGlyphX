@using CodeGlyphX
@inject IJSRuntime JS

@if (Host is null)
{
    <div class="card" style="margin-top: 2rem;">
        <h2>Code Example</h2>
        <p>Loading...</p>
    </div>
}
else
{
    <div class="card" style="margin-top: 2rem;">
        <h2>Code Example</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
            Here's how to generate this exact code in your .NET application:
        </p>

        <div class="code-tabs">
            <button class="code-tab @(SelectedPlatform == "Console" ? "active" : "")" @onclick="@(() => SetPlatform("Console"))">Console</button>
            <button class="code-tab @(SelectedPlatform == "AspNet" ? "active" : "")" @onclick="@(() => SetPlatform("AspNet"))">ASP.NET</button>
            <button class="code-tab @(SelectedPlatform == "Blazor" ? "active" : "")" @onclick="@(() => SetPlatform("Blazor"))">Blazor</button>
            <button class="code-tab @(SelectedPlatform == "Maui" ? "active" : "")" @onclick="@(() => SetPlatform("Maui"))">MAUI</button>
        </div>

        <div class="code-tabs">
            <button class="code-tab @(SelectedLanguage == Playground.CodeLanguage.CSharp ? "active" : "")" @onclick="@(() => SetLanguage(Playground.CodeLanguage.CSharp))">C#</button>
            <button class="code-tab @(SelectedLanguage == Playground.CodeLanguage.Vb ? "active" : "")" @onclick="@(() => SetLanguage(Playground.CodeLanguage.Vb))">VB.NET</button>
        </div>

        <pre class="code-block @GetLanguageCssClass()" @key="@_codeBlockKey">@GetPlatformExample()</pre>
    </div>
}

@code {
    [CascadingParameter]
    public Playground? Host { get; set; }

    private string SelectedPlatform { get; set; } = "Console";
    private Playground.CodeLanguage SelectedLanguage { get; set; } = Playground.CodeLanguage.CSharp;
    private int _codeBlockKey = 0;

    private void SetPlatform(string platform)
    {
        SelectedPlatform = platform;
        _codeBlockKey++; // Force new element to avoid JS-modified DOM conflicts
        StateHasChanged();
    }

    private void SetLanguage(Playground.CodeLanguage language)
    {
        SelectedLanguage = language;
        _codeBlockKey++; // Force new element to avoid JS-modified DOM conflicts
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("CodeGlyphX.initCodeBlocks");
    }

    private string GetPlatformExample()
    {
        if (Host is null) return "";

        var baseCode = Host.GetCodeExample(SelectedLanguage);

        return SelectedPlatform switch
        {
            "AspNet" => GetAspNetExample(SelectedLanguage, baseCode),
            "Blazor" => GetBlazorExample(SelectedLanguage, baseCode),
            "Maui" => GetMauiExample(SelectedLanguage, baseCode),
            _ => baseCode
        };
    }

    private string GetAspNetExample(Playground.CodeLanguage language, string baseCode)
    {
        if (Host?.SelectedMode == "Decode") return baseCode;

        if (language == Playground.CodeLanguage.Vb)
        {
            return GetAspNetExampleVb();
        }

        var nl = "\n";
        var category = Host?.SelectedCategory ?? "QR";

        if (category == "QR" || category == "SpecialQR")
        {
            return "// ASP.NET Core Minimal API endpoint" + nl
                + "app.MapGet(\"/qr\", () =>" + nl
                + "{" + nl
                + "    var png = QR.ToPng(\"" + EscapeForComment(Host?.Content ?? "https://example.com") + "\");" + nl
                + "    return Results.File(png, \"image/png\", \"qrcode.png\");" + nl
                + "});" + nl + nl
                + "// Or in a Controller" + nl
                + "[HttpGet(\"qr/{text}\")]" + nl
                + "public IActionResult GetQrCode(string text)" + nl
                + "{" + nl
                + "    var png = QR.ToPng(text);" + nl
                + "    return File(png, \"image/png\");" + nl
                + "}";
        }
        else if (category == "Barcode")
        {
            return "// ASP.NET Core Minimal API endpoint" + nl
                + "app.MapGet(\"/barcode/{text}\", (string text) =>" + nl
                + "{" + nl
                + "    var png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", text);" + nl
                + "    return Results.File(png, \"image/png\", \"barcode.png\");" + nl
                + "});" + nl + nl
                + "// Or in a Controller" + nl
                + "[HttpGet(\"barcode/{text}\")]" + nl
                + "public IActionResult GetBarcode(string text)" + nl
                + "{" + nl
                + "    var png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", text);" + nl
                + "    return File(png, \"image/png\");" + nl
                + "}";
        }
        else
        {
            var method = Host?.SelectedMatrixType switch
            {
                "Pdf417" => "Pdf417Code",
                "Aztec" => "AztecCode",
                _ => "DataMatrixCode"
            };
            return "// ASP.NET Core Minimal API endpoint" + nl
                + "app.MapGet(\"/matrix/{text}\", (string text) =>" + nl
                + "{" + nl
                + "    var png = " + method + ".ToPng(text);" + nl
                + "    return Results.File(png, \"image/png\", \"matrix.png\");" + nl
                + "});" + nl + nl
                + "// Or in a Controller" + nl
                + "[HttpGet(\"matrix/{text}\")]" + nl
                + "public IActionResult GetMatrix(string text)" + nl
                + "{" + nl
                + "    var png = " + method + ".ToPng(text);" + nl
                + "    return File(png, \"image/png\");" + nl
                + "}";
        }
    }

    private string GetBlazorExample(Playground.CodeLanguage language, string baseCode)
    {
        if (Host?.SelectedMode == "Decode") return baseCode;

        if (language == Playground.CodeLanguage.Vb)
        {
            return "// VB.NET isn't supported in Blazor components yet; showing C#." + "\n" + GetBlazorExample(Playground.CodeLanguage.CSharp, baseCode);
        }

        var nl = "\n";
        var category = Host?.SelectedCategory ?? "QR";

        if (category == "QR" || category == "SpecialQR")
        {
            return "// Blazor component with dynamic QR code" + nl
                + "@using CodeGlyphX" + nl + nl
                + "<img src=\"@_qrDataUri\" alt=\"QR Code\" />" + nl + nl
                + "@code {" + nl
                + "    private string _qrDataUri = \"\";" + nl + nl
                + "    protected override void OnInitialized()" + nl
                + "    {" + nl
                + "        var png = QR.ToPng(\"" + EscapeForComment(Host?.Content ?? "https://example.com") + "\");" + nl
                + "        _qrDataUri = $\"data:image/png;base64,{Convert.ToBase64String(png)}\";" + nl
                + "    }" + nl
                + "}";
        }
        else if (category == "Barcode")
        {
            return "// Blazor component with dynamic barcode" + nl
                + "@using CodeGlyphX" + nl + nl
                + "<img src=\"@_barcodeDataUri\" alt=\"Barcode\" />" + nl + nl
                + "@code {" + nl
                + "    private string _barcodeDataUri = \"\";" + nl + nl
                + "    protected override void OnInitialized()" + nl
                + "    {" + nl
                + "        var png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", \"" + EscapeForComment(Host?.BarcodeContent ?? "12345") + "\");" + nl
                + "        _barcodeDataUri = $\"data:image/png;base64,{Convert.ToBase64String(png)}\";" + nl
                + "    }" + nl
                + "}";
        }
        else
        {
            var method = Host?.SelectedMatrixType switch
            {
                "Pdf417" => "Pdf417Code",
                "Aztec" => "AztecCode",
                _ => "DataMatrixCode"
            };
            return "// Blazor component with dynamic matrix code" + nl
                + "@using CodeGlyphX" + nl + nl
                + "<img src=\"@_matrixDataUri\" alt=\"Matrix Code\" />" + nl + nl
                + "@code {" + nl
                + "    private string _matrixDataUri = \"\";" + nl + nl
                + "    protected override void OnInitialized()" + nl
                + "    {" + nl
                + "        var png = " + method + ".ToPng(\"" + EscapeForComment(Host?.MatrixContent ?? "Data") + "\");" + nl
                + "        _matrixDataUri = $\"data:image/png;base64,{Convert.ToBase64String(png)}\";" + nl
                + "    }" + nl
                + "}";
        }
    }

    private string GetMauiExample(Playground.CodeLanguage language, string baseCode)
    {
        if (Host?.SelectedMode == "Decode") return baseCode;

        if (language == Playground.CodeLanguage.Vb)
        {
            return GetMauiExampleVb();
        }

        var nl = "\n";
        var category = Host?.SelectedCategory ?? "QR";

        if (category == "QR" || category == "SpecialQR")
        {
            return "// .NET MAUI - Display QR code in Image control" + nl
                + "using CodeGlyphX;" + nl + nl
                + "// In your ViewModel or code-behind:" + nl
                + "var png = QR.ToPng(\"" + EscapeForComment(Host?.Content ?? "https://example.com") + "\");" + nl
                + "QrImage.Source = ImageSource.FromStream(() => new MemoryStream(png));" + nl + nl
                + "// XAML:" + nl
                + "// <Image x:Name=\"QrImage\" WidthRequest=\"200\" HeightRequest=\"200\" />";
        }
        else if (category == "Barcode")
        {
            return "// .NET MAUI - Display barcode in Image control" + nl
                + "using CodeGlyphX;" + nl + nl
                + "// In your ViewModel or code-behind:" + nl
                + "var png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", \"" + EscapeForComment(Host?.BarcodeContent ?? "12345") + "\");" + nl
                + "BarcodeImage.Source = ImageSource.FromStream(() => new MemoryStream(png));" + nl + nl
                + "// XAML:" + nl
                + "// <Image x:Name=\"BarcodeImage\" WidthRequest=\"300\" HeightRequest=\"100\" />";
        }
        else
        {
            var method = Host?.SelectedMatrixType switch
            {
                "Pdf417" => "Pdf417Code",
                "Aztec" => "AztecCode",
                _ => "DataMatrixCode"
            };
            return "// .NET MAUI - Display matrix code in Image control" + nl
                + "using CodeGlyphX;" + nl + nl
                + "// In your ViewModel or code-behind:" + nl
                + "var png = " + method + ".ToPng(\"" + EscapeForComment(Host?.MatrixContent ?? "Data") + "\");" + nl
                + "MatrixImage.Source = ImageSource.FromStream(() => new MemoryStream(png));" + nl + nl
                + "// XAML:" + nl
                + "// <Image x:Name=\"MatrixImage\" WidthRequest=\"200\" HeightRequest=\"200\" />";
        }
    }

    private string GetAspNetExampleVb()
    {
        var nl = "\n";
        var category = Host?.SelectedCategory ?? "QR";

        if (category == "QR" || category == "SpecialQR")
        {
            return "' ASP.NET Core Controller example" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports Microsoft.AspNetCore.Mvc" + nl + nl
                + "Public Class QrController" + nl
                + "    Inherits ControllerBase" + nl + nl
                + "    <HttpGet(\"qr/{text}\")>" + nl
                + "    Public Function GetQrCode(text As String) As IActionResult" + nl
                + "        Dim png = QR.ToPng(text)" + nl
                + "        Return File(png, \"image/png\", \"qrcode.png\")" + nl
                + "    End Function" + nl
                + "End Class";
        }
        else if (category == "Barcode")
        {
            return "' ASP.NET Core Controller example" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports Microsoft.AspNetCore.Mvc" + nl + nl
                + "Public Class BarcodeController" + nl
                + "    Inherits ControllerBase" + nl + nl
                + "    <HttpGet(\"barcode/{text}\")>" + nl
                + "    Public Function GetBarcode(text As String) As IActionResult" + nl
                + "        Dim png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", text)" + nl
                + "        Return File(png, \"image/png\", \"barcode.png\")" + nl
                + "    End Function" + nl
                + "End Class";
        }
        else
        {
            var method = Host?.SelectedMatrixType switch
            {
                "Pdf417" => "Pdf417Code",
                "Aztec" => "AztecCode",
                _ => "DataMatrixCode"
            };
            return "' ASP.NET Core Controller example" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports Microsoft.AspNetCore.Mvc" + nl + nl
                + "Public Class MatrixController" + nl
                + "    Inherits ControllerBase" + nl + nl
                + "    <HttpGet(\"matrix/{text}\")>" + nl
                + "    Public Function GetMatrix(text As String) As IActionResult" + nl
                + "        Dim png = " + method + ".ToPng(text)" + nl
                + "        Return File(png, \"image/png\", \"matrix.png\")" + nl
                + "    End Function" + nl
                + "End Class";
        }
    }

    private string GetMauiExampleVb()
    {
        var nl = "\n";
        var category = Host?.SelectedCategory ?? "QR";

        if (category == "QR" || category == "SpecialQR")
        {
            return "' .NET MAUI - Display QR code in Image control" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports System.IO" + nl + nl
                + "' In your ViewModel or code-behind:" + nl
                + "Dim png = QR.ToPng(\"" + EscapeForVbString(Host?.Content ?? "https://example.com") + "\")" + nl
                + "QrImage.Source = ImageSource.FromStream(Function() New MemoryStream(png))" + nl + nl
                + "' XAML:" + nl
                + "' <Image x:Name=\"QrImage\" WidthRequest=\"200\" HeightRequest=\"200\" />";
        }
        else if (category == "Barcode")
        {
            return "' .NET MAUI - Display barcode in Image control" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports System.IO" + nl + nl
                + "' In your ViewModel or code-behind:" + nl
                + "Dim png = Barcode.Png(BarcodeType." + (Host?.GetBarcodeTypeEnumName() ?? "Code128") + ", \"" + EscapeForVbString(Host?.BarcodeContent ?? "12345") + "\")" + nl
                + "BarcodeImage.Source = ImageSource.FromStream(Function() New MemoryStream(png))" + nl + nl
                + "' XAML:" + nl
                + "' <Image x:Name=\"BarcodeImage\" WidthRequest=\"300\" HeightRequest=\"100\" />";
        }
        else
        {
            var method = Host?.SelectedMatrixType switch
            {
                "Pdf417" => "Pdf417Code",
                "Aztec" => "AztecCode",
                _ => "DataMatrixCode"
            };
            return "' .NET MAUI - Display matrix code in Image control" + nl
                + "Imports CodeGlyphX" + nl
                + "Imports System.IO" + nl + nl
                + "' In your ViewModel or code-behind:" + nl
                + "Dim png = " + method + ".ToPng(\"" + EscapeForVbString(Host?.MatrixContent ?? "Data") + "\")" + nl
                + "MatrixImage.Source = ImageSource.FromStream(Function() New MemoryStream(png))" + nl + nl
                + "' XAML:" + nl
                + "' <Image x:Name=\"MatrixImage\" WidthRequest=\"200\" HeightRequest=\"200\" />";
        }
    }

    private string GetLanguageCssClass()
    {
        if (Host?.SelectedMode == "Decode")
        {
            return SelectedLanguage == Playground.CodeLanguage.Vb ? "language-vbnet" : "language-csharp";
        }

        if (SelectedPlatform == "Blazor" && SelectedLanguage == Playground.CodeLanguage.Vb)
        {
            return "language-csharp";
        }

        return SelectedLanguage == Playground.CodeLanguage.Vb ? "language-vbnet" : "language-csharp";
    }

    private static string EscapeForComment(string s) => s.Replace("\\", "\\\\").Replace("\"", "\\\"");

    private static string EscapeForVbString(string s) => s.Replace("\"", "\"\"");
}
